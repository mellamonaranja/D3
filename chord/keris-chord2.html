<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <title>Indented Tree</title>
  <style>
    body {
      font: 20px sans-serif;
    }

    .group-tick line {
      stroke: #000;
    }

    .ribbons {
      fill-opacity: 0.67;
    }
  </style>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script>
    function onLOAD() {
      const data = Object.assign([
      [1.000000,0.619603,0.375351,0.535931], 
        [0.619603,1.000000,0.121413,0.852769], 
        [0.375351,0.121413,1.000000,-0.275207], 
        [0.535931,0.852769,-0.275207,1.000000],
      ], {
        names: ['1week','1month','2months','3months'],
        // colors: ["#6FCDE3", 
        //     "#D7DAE5", 
        //     "#D7DAE5", 
        //     "#D7DAE5", 
        //     "#D7DAE5", 
        //     "#D7DAE5", 
        //     "#E5E52B",
        //     "#D7DAE5",
        //     "#D7DAE5", 
        //     "#D7DAE5", 
        //     "#D7DAE5", 
        //     "#D7DAE5"]
      })
      



      const width = 1000;
      const height = width;
      const outerRadius = Math.min(width, height) * 0.5 - 100
      const innerRadius = outerRadius - 10
      const names = data.names === undefined ? d3.range(data.length) : data.names
      const colors = data.colors === undefined ? d3.quantize(d3.interpolateRainbow, names.length) : data.colors
      console.log(data);
      console.log(data.names, data.colors);
      const color = d3.scaleOrdinal(names, colors)

      const ribbon = d3.ribbon()
        .radius(innerRadius - 1)
        .padAngle(1 / innerRadius)
      const arc = d3.arc()
        .innerRadius(innerRadius)
        .outerRadius(outerRadius)

      const formatValue = d3.format(".1~%")
      const tickStep = d3.tickStep(0, d3.sum(data.flat()), 10)


      function ticks({ startAngle, endAngle, value }) {
        const k = (endAngle - startAngle) / value;
        return d3.range(0, value, tickStep).map(value => {
          return { value, angle: value * k + startAngle };
        });
      }


      const chord = d3.chord()
        .padAngle(10 / innerRadius)
        .sortSubgroups(d3.descending)
        .sortChords(d3.descending)

      const svg = d3.select("svg").attr("viewBox", [-width / 2, -height / 2, width, height]);

      const chords = chord(data);

      const group = svg.append("g")
        .attr("font-size", 20)
        .attr("font-family", "sans-serif")
        .selectAll("g")
        .data(chords.groups)
        .join("g");

      group.append("path")
        .attr("fill", d => color(names[d.index]))
        .attr("d", arc);

      group.append("title")
        .text(d => `${names[d.index]} ${formatValue(d.value)}`);

      const groupTick = group.append("g")
        .selectAll("g")
        .data(ticks)
        .join("g")
        .attr("transform", d => `rotate(${d.angle * 180 / Math.PI - 90}) translate(${outerRadius},0)`);

      groupTick.append("line")
        .attr("stroke", "currentColor")
        .attr("x2", 6);

      groupTick.append("text")
        .attr("x", 8)
        .attr("dy", "0.35em")
        .attr("transform", d => d.angle > Math.PI ? "rotate(180) translate(-16)" : null)
        .attr("text-anchor", d => d.angle > Math.PI ? "end" : null)
        .text(d => formatValue(d.value));

      group.select("text")
        .attr("font-weight", "bold")
        .text(function(d) {
          return this.getAttribute("text-anchor") === "end"
            ? `↑ ${names[d.index]}`
            : `${names[d.index]} ↓`;
        });

      svg.append("g")
        .attr("fill-opacity", 0.8)
        .selectAll("path")
        .data(chords)
        .join("path")
        .style("mix-blend-mode", "multiply")
        .attr("fill", d => color(names[d.source.index]))
        .attr("d", ribbon)
        .append("title")
        .text((d) => `${formatValue(d.source.value)} ${names[d.target.index]} → ${names[d.source.index]}${d.source.index === d.target.index ? "" : `\n${formatValue(d.target.value)} ${names[d.source.index]} → ${names[d.target.index]}`}`);

    } 
  </script>
</head>

<body onload="onLOAD()">
  <svg width="1000" height="1000"></svg>
</body>

</html>